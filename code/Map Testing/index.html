<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <style>
        #mapid {
            height: 800px;
        }
    </style>
</head>

<body>
    <div id="mapid"></div>

    <input id="slider" type="range" min="0" max="274" width="100%">
    <p id="date"></p>

    <script>
        (async function() {
            window.mymap = L.map('mapid').setView([54.898, -5.416], 6);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>, <a href="https://coronavirus.data.gov.uk/details/interactive-map#:~:text=Attributions">Data and Boundaries © </a>',
                maxZoom: 18,
                id: 'mapbox/light-v10',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoiYmluYXJ5b3ZlcmxvYWQiLCJhIjoiY2tsbXN2dDg5MGNlMDJvbXVicnN3Y2RxOSJ9.yCG6Sk6vz7qdhVT2gsWkpA'
            }).addTo(window.mymap);
            let counties = await fetch("countyCodes.json").then(data => data.json())
            let mapData = await fetch('https://coronavirus.data.gov.uk/downloads/maps/utla-ref.geojson').then(data => data.json())
                // let mapData = await fetch('https://coronavirus.data.gov.uk/downloads/maps/utla_data_latest.geojson').then(data => data.json())

            window.covidData = await fetch("covid-data.csv")
                .then(data => data.text())
                .then(body => body.split("\n").map(line => line.split(/,(?![^,]+")/g)))

            let covidMap = covidData.filter(line => line[0] === "31/10/2020").map(line => [line[2], line[4]]).reduce((map, line) => {
                map[line[0]] = +line[1]
                return map;
            }, {})

            L.geoJSON(mapData).bindPopup(function(layer) {
                return counties[layer.feature.properties.code] + " (" + layer.feature.properties.code + ") - " + covidMap[layer.feature.properties.code];
            }).addTo(window.mymap);

            setStyles("31/10/2020")

        })()

        document.getElementById("slider").addEventListener("input", slider)

        function getSliderDate(value) {
            let date = new Date(2020, 0, 31)
            date.setDate(date.getDate() + value)
            return date
        }

        function slider(e) {
            let date = getSliderDate(parseInt(e.target.value))
            let dateString = `${Math.max(date.getDay(), 1).toString().padStart(2, "0")}/${(date.getMonth() + 1).toString().padStart(2, "0")}/${date.getFullYear()}`
            document.getElementById("date").innerText = dateString
            setStyles(dateString)
        }

        function getGradientColor(start_color, end_color, percent) {
            // strip the leading # if it's there
            start_color = start_color.replace(/^\s*#|\s*$/g, '');
            end_color = end_color.replace(/^\s*#|\s*$/g, '');

            // convert 3 char codes --> 6, e.g. `E0F` --> `EE00FF`
            if (start_color.length == 3) {
                start_color = start_color.replace(/(.)/g, '$1$1');
            }

            if (end_color.length == 3) {
                end_color = end_color.replace(/(.)/g, '$1$1');
            }

            // get colors
            var start_red = parseInt(start_color.substr(0, 2), 16),
                start_green = parseInt(start_color.substr(2, 2), 16),
                start_blue = parseInt(start_color.substr(4, 2), 16);

            var end_red = parseInt(end_color.substr(0, 2), 16),
                end_green = parseInt(end_color.substr(2, 2), 16),
                end_blue = parseInt(end_color.substr(4, 2), 16);

            // calculate new color
            var diff_red = end_red - start_red;
            var diff_green = end_green - start_green;
            var diff_blue = end_blue - start_blue;

            diff_red = ((diff_red * percent) + start_red).toString(16).split('.')[0];
            diff_green = ((diff_green * percent) + start_green).toString(16).split('.')[0];
            diff_blue = ((diff_blue * percent) + start_blue).toString(16).split('.')[0];

            // ensure 2 digits by color
            if (diff_red.length == 1) diff_red = '0' + diff_red
            if (diff_green.length == 1) diff_green = '0' + diff_green
            if (diff_blue.length == 1) diff_blue = '0' + diff_blue

            return '#' + diff_red + diff_green + diff_blue;
        }

        function setStyles(date) {

            let data = covidData.filter(line => line[0] === date)

            let minCovid = Math.min(...data.map(line => +line[4]))
            let maxCovid = Math.max(...data.map(line => +line[4]))

            let covidRanking = data.map(line => [line[2], line[4]]).reduce((map, line) => {
                let scaled = ((+line[1] - minCovid) / (maxCovid - minCovid))
                map[line[0]] = Math.min(scaled * 3, 1);
                return map;
            }, {})

            window.mymap.eachLayer(function(layer) {
                if (layer.setStyle && layer.feature) {
                    layer.setStyle({
                        color: getGradientColor('#00ff00', '#ff0000', covidRanking[layer.feature.properties.code])
                    })
                }
            })

        }
    </script>
</body>

</html>